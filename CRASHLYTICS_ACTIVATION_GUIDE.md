# Crashlytics and Firebase Services Activation Guide

Quick guide to activate Firebase Crashlytics, Analytics, and Performance Monitoring after completing Firebase setup (P0.5).

**Prerequisites:** Firebase project created and config files added (see FIREBASE_SETUP_GUIDE.md)

---

## Step 1: Install FlutterFire CLI

The FlutterFire CLI generates platform-specific Firebase configuration.

```bash
dart pub global activate flutterfire_cli
```

**Verify installation:**
```bash
flutterfire --version
```

---

## Step 2: Configure Firebase for Flutter

Run the FlutterFire configuration command:

```bash
cd /home/user/sortbliss
flutterfire configure
```

**Select options:**
1. **Select Firebase project:** Choose your SortBliss project
2. **Select platforms:** iOS, Android (use spacebar to select, enter to confirm)
3. **iOS bundle ID:** com.sortbliss.app
4. **Android package name:** com.sortbliss.app

**This command will:**
- Generate `lib/firebase_options.dart` with platform-specific config
- Link your Flutter app to Firebase project
- Configure Firebase for both iOS and Android

---

## Step 3: Uncomment Firebase Dependencies

Edit `pubspec.yaml` and uncomment the Firebase dependencies (lines 44-47):

**Before:**
```yaml
# TODO: Uncomment after Firebase setup (P0.5)
# cloud_functions: ^4.5.0      # Firebase Cloud Functions for IAP receipt validation
# firebase_core: ^2.24.0       # Firebase core SDK - required for all Firebase services
# firebase_crashlytics: ^3.4.8 # Crash reporting and analytics
# firebase_analytics: ^10.7.4  # User behavior analytics and funnels
# firebase_performance: ^0.9.3+8 # Performance monitoring and traces
```

**After:**
```yaml
cloud_functions: ^4.5.0      # Firebase Cloud Functions for IAP receipt validation
firebase_core: ^2.24.0       # Firebase core SDK - required for all Firebase services
firebase_crashlytics: ^3.4.8 # Crash reporting and analytics
firebase_analytics: ^10.7.4  # User behavior analytics and funnels
firebase_performance: ^0.9.3+8 # Performance monitoring and traces
```

**Install dependencies:**
```bash
flutter pub get
```

---

## Step 4: Activate Crashlytics in main.dart

Edit `lib/main.dart` and uncomment the Firebase imports and initialization code.

### 4.1 Uncomment Imports (lines 24-27)

**Before:**
```dart
// TODO: Uncomment after Firebase setup (P0.5)
// import 'package:firebase_core/firebase_core.dart';
// import 'package:firebase_crashlytics/firebase_crashlytics.dart';
// import 'firebase_options.dart'; // Generated by flutterfire configure
```

**After:**
```dart
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_crashlytics/firebase_crashlytics.dart';
import 'firebase_options.dart'; // Generated by flutterfire configure
```

### 4.2 Uncomment Firebase Initialization (lines 46-64)

**Before:**
```dart
// TODO: Uncomment after Firebase setup (P0.5) - Step 1 of 3
// Initialize Firebase
// await Firebase.initializeApp(
//   options: DefaultFirebaseOptions.currentPlatform,
// );
```

**After:**
```dart
// Initialize Firebase
await Firebase.initializeApp(
  options: DefaultFirebaseOptions.currentPlatform,
);
```

### 4.3 Uncomment Error Handlers (lines 52-64)

**Before:**
```dart
// TODO: Uncomment after Firebase setup (P0.5) - Step 2 of 3
// Pass all uncaught Flutter errors to Crashlytics
// FlutterError.onError = (FlutterErrorDetails details) {
//   FlutterError.presentError(details);
//   FirebaseCrashlytics.instance.recordFlutterFatalError(details);
// };
```

**After:**
```dart
// Pass all uncaught Flutter errors to Crashlytics
FlutterError.onError = (FlutterErrorDetails details) {
  FlutterError.presentError(details);
  FirebaseCrashlytics.instance.recordFlutterFatalError(details);
};

// Pass all uncaught asynchronous errors to Crashlytics
PlatformDispatcher.instance.onError = (error, stack) {
  FirebaseCrashlytics.instance.recordError(error, stack, fatal: true);
  return true;
};
```

### 4.4 Remove Temporary Error Handler

Delete or comment out the temporary error handler (lines 66-69):

```dart
// Custom error handling (keep this until Firebase is set up)
FlutterError.onError = (FlutterErrorDetails details) {
  FlutterError.presentError(details);
};
```

---

## Step 5: Activate Crashlytics in TelemetryManager

Edit `lib/core/telemetry/telemetry_manager.dart`.

### 5.1 Uncomment Imports (lines 4-6)

**Before:**
```dart
// TODO: Uncomment after Firebase setup (P0.5)
// import 'package:firebase_crashlytics/firebase_crashlytics.dart';
// import 'package:firebase_performance/firebase_performance.dart';
```

**After:**
```dart
import 'package:firebase_crashlytics/firebase_crashlytics.dart';
import 'package:firebase_performance/firebase_performance.dart';
```

### 5.2 Uncomment Crashlytics Initialization (lines 36-42)

**Before:**
```dart
// TODO: Uncomment after Firebase setup (P0.5) - Step 1 of 2
// Enable Crashlytics collection (disabled in debug mode to avoid test crashes)
// await FirebaseCrashlytics.instance.setCrashlyticsCollectionEnabled(!kDebugMode);
```

**After:**
```dart
// Enable Crashlytics collection (disabled in debug mode to avoid test crashes)
await FirebaseCrashlytics.instance.setCrashlyticsCollectionEnabled(!kDebugMode);

// Initialize Firebase Performance Monitoring
final _ = FirebasePerformance.instance;
```

### 5.3 Uncomment Error Recording (lines 66-74)

**Before:**
```dart
// TODO: Uncomment after Firebase setup (P0.5)
// Send error to Firebase Crashlytics for tracking and analysis
// await FirebaseCrashlytics.instance.recordError(
//   exception,
//   stackTrace,
//   reason: reason,
//   information: context?.entries.map((e) => '${e.key}: ${e.value}').toList() ?? [],
//   fatal: false,
// );
```

**After:**
```dart
// Send error to Firebase Crashlytics for tracking and analysis
await FirebaseCrashlytics.instance.recordError(
  exception,
  stackTrace,
  reason: reason,
  information: context?.entries.map((e) => '${e.key}: ${e.value}').toList() ?? [],
  fatal: false,
);
```

### 5.4 Uncomment User ID and Custom Keys (lines 83-94)

**Before:**
```dart
// TODO: Uncomment after Firebase setup (P0.5)
// Set user ID in Crashlytics for crash attribution
// FirebaseCrashlytics.instance.setUserIdentifier(userId);
```

**After:**
```dart
// Set user ID in Crashlytics for crash attribution
FirebaseCrashlytics.instance.setUserIdentifier(userId);

// And for custom keys:
FirebaseCrashlytics.instance.setCustomKey(key, value);
```

### 5.5 Uncomment Performance Traces (lines 251-258)

**Before:**
```dart
// TODO: Uncomment after Firebase setup (P0.5)
// Send performance trace to Firebase Performance Monitoring
// final firebaseTrace = FirebasePerformance.instance.newTrace(name);
// await firebaseTrace.start();
// _metrics.forEach((key, value) {
//   firebaseTrace.setMetric(key, value.toInt());
// });
// await firebaseTrace.stop();
```

**After:**
```dart
// Send performance trace to Firebase Performance Monitoring
final firebaseTrace = FirebasePerformance.instance.newTrace(name);
await firebaseTrace.start();
_metrics.forEach((key, value) {
  firebaseTrace.setMetric(key, value.toInt());
});
await firebaseTrace.stop();
```

---

## Step 6: Activate IAP Receipt Validation

Edit `lib/core/monetization/monetization_manager.dart`.

### 6.1 Uncomment Cloud Functions Import (line 8)

**Before:**
```dart
// TODO: Uncomment after Firebase setup (P0.5)
// import 'package:cloud_functions/cloud_functions.dart';
```

**After:**
```dart
import 'package:cloud_functions/cloud_functions.dart';
```

### 6.2 Uncomment Receipt Validation (lines 200-254)

Remove the `/*` and `*/` comment markers around the receipt validation code.

### 6.3 Remove Temporary Bypass (lines 256-263)

Delete the temporary bypass that allows all purchases:

```dart
// TEMPORARY: Allow all purchases until Firebase is set up
debugPrint('WARNING: Receipt validation disabled - Firebase not configured');
AnalyticsLogger.logEvent('iap_receipt_validation_skipped', parameters: {
  'productId': purchaseDetails.productID,
  'reason': 'Firebase not configured',
});
return true;
```

---

## Step 7: Build and Test

### 7.1 Clean and Rebuild

```bash
flutter clean
flutter pub get
flutter run --release
```

### 7.2 Test Crash Reporting

**Add a test crash to verify Crashlytics is working:**

In `lib/main.dart`, add a test button somewhere in your app:

```dart
ElevatedButton(
  onPressed: () {
    // Force a crash to test Crashlytics
    FirebaseCrashlytics.instance.crash();
  },
  child: Text('Test Crash'),
)
```

**Or force an error:**

```dart
ElevatedButton(
  onPressed: () {
    throw Exception('Test exception for Crashlytics');
  },
  child: Text('Test Error'),
)
```

### 7.3 Verify in Firebase Console

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Select your project
3. Navigate to "Crashlytics"
4. Wait 5-10 minutes for crashes to appear
5. You should see test crash or error in the dashboard

**Note:** Crashes may take up to 10 minutes to appear in Firebase Console.

### 7.4 Test Performance Monitoring

Performance traces are automatically collected. Check Firebase Console > Performance after running the app for a few minutes.

---

## Step 8: Verify Analytics Integration

Firebase Analytics is automatically initialized with `firebase_core`.

**Test analytics events:**

The app already logs events through `AnalyticsLogger`. After uncommenting Firebase dependencies, these events will automatically flow to Firebase Analytics.

**Verify in Firebase Console:**
1. Go to Firebase Console > Analytics > Events
2. Wait 24 hours for events to appear (Analytics has delay)
3. Check for events like:
   - `telemetry_initialized`
   - `iap_purchase_initiated`
   - `ad_impression_recorded`

---

## Troubleshooting

### Build fails with "firebase_options.dart not found"

**Solution:**
```bash
flutterfire configure
```

This generates the missing `firebase_options.dart` file.

### Crashes not appearing in Firebase Console

**Causes:**
1. Crashlytics takes 5-10 minutes to process crashes
2. Debug builds may not send crashes
3. Internet connection required

**Solutions:**
1. Wait 10 minutes
2. Test with release build: `flutter run --release`
3. Check device has internet connection
4. Force app to foreground/background to trigger upload

### "FirebaseCrashlytics instance not initialized"

**Cause:** Firebase.initializeApp() not called before accessing Crashlytics

**Solution:** Ensure Firebase initialization happens before Crashlytics usage in `main.dart`

### Performance traces not appearing

**Causes:**
1. Performance data takes 24 hours to appear
2. Minimum thresholds for trace duration

**Solutions:**
1. Wait 24 hours
2. Create longer traces (>100ms)
3. Check Firebase Console > Performance after 24 hours

---

## Summary Checklist

After completing this guide:

- ✅ FlutterFire CLI installed
- ✅ Firebase configured with `flutterfire configure`
- ✅ Firebase dependencies uncommented in `pubspec.yaml`
- ✅ `flutter pub get` completed successfully
- ✅ Firebase imports uncommented in `main.dart`
- ✅ Firebase initialization uncommented in `main.dart`
- ✅ Error handlers uncommented in `main.dart`
- ✅ Crashlytics code uncommented in `telemetry_manager.dart`
- ✅ Performance monitoring code uncommented in `telemetry_manager.dart`
- ✅ Cloud Functions import uncommented in `monetization_manager.dart`
- ✅ Receipt validation code uncommented in `monetization_manager.dart`
- ✅ App built and tested with release mode
- ✅ Test crash sent to Firebase Crashlytics
- ✅ Crashlytics dashboard shows test crash

**Estimated Time:** 20-30 minutes

**Verification Command:**
```bash
# Check if Firebase is properly configured
grep -r "Firebase.initializeApp" lib/main.dart
grep -r "FirebaseCrashlytics" lib/core/telemetry/telemetry_manager.dart
grep -r "cloud_functions:" pubspec.yaml

# All three should return results (not commented out)
```

---

## Next Steps

After Crashlytics is active:

1. **Remove test crash button** - Don't ship test crash code to production
2. **Monitor crashes daily** - Check Firebase Console > Crashlytics
3. **Set up alerts** - Configure email alerts for new crashes
4. **Integrate with deployment** - Track crash-free rate per release
5. **Deploy Cloud Functions** - Follow CLOUD_FUNCTIONS_DEPLOYMENT_GUIDE.md

---

**Questions?** Check [Firebase Crashlytics Documentation](https://firebase.google.com/docs/crashlytics/get-started?platform=flutter)
